// ====== i18n dictionary ======
const dict = {
  es: {
    slogan: "Tu viaje, a tiempo y seguro",

    nav_services: "Servicios",
    nav_auction: "Subastas",
    nav_reviews: "Calificación",
    nav_contact: "Anticipa tu servicio",
    nav_whatsapp: "WhatsApp",

    hero_pill: "Danbury • Connecticut • 24/7",
    hero_title: "Traslados profesionales dentro y fuera del estado",
    hero_sub: "Aeropuertos, delivery, prueba del DMV, jump start y apertura de puertas. Atención rápida y amable.",

    btn_services: "Ver servicios",
    btn_rate: "Danos ⭐⭐⭐⭐⭐",
    btn_book: "Anticipa tu servicio",
    btn_whatsapp_1: "WhatsApp 1",
    btn_whatsapp_2: "WhatsApp 2",

    badge_1: "Disponibilidad",
    badge_2: "Rutas claras",
    badge_3: "Servicio premium",

    quick_title: "Pide tu servicio en segundos",
    quick_sub: "Toca WhatsApp y dinos destino + hora. Te respondemos rápido.",
    quick_note: "*Pagos en efectivo. Servicio dentro y fuera de CT.",

    special_title: "Servicios Especiales",
    special_sub: "Elige el servicio y escríbenos por WhatsApp. Te confirmamos rápido.",
    svc_cta: "Cotizar ahora",

    svc_airports_t: "Traslados a los Aeropuertos",
    svc_airports_d: "Recogida puntual, seguimiento de vuelo y un viaje cómodo desde/hacia cualquier aeropuerto.",

    svc_delivery_t: "Delivery",
    svc_delivery_d: "Comida, medicina, bebidas y más. Entregas rápidas con confirmación por WhatsApp.",

    svc_dmv_t: "Vehículo para Prueba del DMV",
    svc_dmv_d: "Renta de vehículo para tu road test. Agenda con tiempo y llega listo.",

    svc_jump_t: "Jump Start",
    svc_jump_d: "¿Batería descargada? Te ayudamos a encender tu carro rápido y seguro.",

    svc_lock_t: "Lockout",
    svc_lock_d: "Si dejaste las llaves dentro, abrimos tu vehículo con herramientas propias y cuidado.",

    auction_title: "Te ayudamos a comprar tu vehículo en subastas",
    auction_sub: "Aunque no tengas licencia de dealer, nosotros te guiamos paso a paso para comprar de forma segura.",
    auction_b1: "Acceso a un inventario amplio (más de 1,000 opciones).",
    auction_b2: "Acompañamiento en el proceso y verificación básica.",
    auction_b3: "Precios accesibles y opciones para tu presupuesto.",
    auction_cta: "Quiero información",

    reviews_title: "Danos tus estrellitas",
    reviews_sub: "Tu calificación nos ayuda a crecer. Gracias por apoyar un servicio serio.",
    reviews_btn: "Calificar en Google",
    reviews_note: "Abre Google Maps y deja estrellitas en segundos.",

    rev1: "“Puntuales y muy profesionales. Excelente trato.”",
    rev1a: "Cliente verificado",
    rev2: "“Me ayudaron con mi prueba del DMV. Todo perfecto.”",
    rev2a: "Danbury, CT",
    rev3: "“Delivery rápido y comunicación clara por WhatsApp.”",
    rev3a: "New Milford, CT",

    contact_title: "Anticipa tu servicio",
    contact_sub: "Escríbenos por WhatsApp con destino, hora y tipo de servicio. Te confirmamos enseguida.",
    contact_box_t: "WhatsApp directo",
    contact_box_d: "Toca un botón y envía tu mensaje. Si prefieres, también puedes copiar el número.",
    contact_tip_t: "Tip rápido",
    contact_tip_d: "Envíanos esto y listo:",
    contact_template: "Hola, necesito: (Aeropuerto/Delivery/DMV/Jump Start/Lockout). Dirección: ____. Hora: ____. Gracias.",

    footer_rights: "Derechos reservados.",
    designed_by: "Diseñado por",

    player_title: "Música",

    wa_title: "¿Dónde te llevamos o qué servicio necesitas?"
    form_title: "Anticipa tu servicio",
    form_name: "Nombre",
    form_last: "Apellido",
    form_addr: "Dirección (opcional)",
    form_loc: "Usar mi ubicación",
    form_send: "Enviar por WhatsApp",
    music_title: "Música",
  },

  en: {
    slogan: "On time. Safe. Professional.",

    nav_services: "Services",
    nav_auction: "Auctions",
    nav_reviews: "Reviews",
    nav_contact: "Book ahead",
    nav_whatsapp: "WhatsApp",

    hero_pill: "Danbury • Connecticut • 24/7",
    hero_title: "Professional rides in and out of state",
    hero_sub: "Airports, delivery, DMV road test car, jump start and car lockout. Fast, friendly service.",

    btn_services: "View services",
    btn_rate: "Rate us ⭐⭐⭐⭐⭐",
    btn_book: "Book ahead",
    btn_whatsapp_1: "WhatsApp 1",
    btn_whatsapp_2: "WhatsApp 2",

    badge_1: "Availability",
    badge_2: "Clear routes",
    badge_3: "Premium service",

    quick_title: "Request service in seconds",
    quick_sub: "Tap WhatsApp and send destination + time. We reply fast.",
    quick_note: "*Cash only. Service inside and outside CT.",

    special_title: "Special Services",
    special_sub: "Pick a service and message us on WhatsApp. Quick confirmation.",
    svc_cta: "Get a quote",

    svc_airports_t: "Airport Transfers",
    svc_airports_d: "On-time pickup, flight tracking and a comfortable ride to/from any airport.",

    svc_delivery_t: "Delivery",
    svc_delivery_d: "Food, medicine, beverages and more. Fast delivery with WhatsApp confirmation.",

    svc_dmv_t: "DMV Road Test Car",
    svc_dmv_d: "Car rental for your road test. Schedule ahead and be ready.",

    svc_jump_t: "Jump Start",
    svc_jump_d: "Dead battery? We’ll get your car started quickly and safely.",

    svc_lock_t: "Lockout",
    svc_lock_d: "Keys locked inside? We can open your vehicle with proper tools and care.",

    auction_title: "We help you buy a vehicle at auctions",
    auction_sub: "No dealer license? No problem. We guide you step-by-step to buy safely.",
    auction_b1: "Access to a wide inventory (1,000+ options).",
    auction_b2: "Process guidance and basic checks.",
    auction_b3: "Affordable prices and budget-friendly options.",
    auction_cta: "I want info",

    reviews_title: "Give us your stars",
    reviews_sub: "Your rating helps us grow. Thanks for supporting a serious service.",
    reviews_btn: "Leave a Google review",
    reviews_note: "Open Google Maps and leave stars in seconds.",

    rev1: "“On time and very professional. Great service.”",
    rev1a: "Verified customer",
    rev2: "“They helped with my DMV road test. Perfect.”",
    rev2a: "Danbury, CT",
    rev3: "“Fast delivery and clear WhatsApp communication.”",
    rev3a: "New Milford, CT",

    contact_title: "Book ahead",
    contact_sub: "Message us on WhatsApp with destination, time and service. We’ll confirm right away.",
    contact_box_t: "Direct WhatsApp",
    contact_box_d: "Tap a button and send your message. You can also copy the number.",
    contact_tip_t: "Quick template",
    contact_tip_d: "Send this and you’re set:",
    contact_template: "Hi, I need: (Airport/Delivery/DMV/Jump Start/Lockout). Address: ____. Time: ____. Thank you.",

    footer_rights: "All rights reserved.",
    designed_by: "Designed by",

    player_title: "Music",

    wa_title: "Where are we taking you or what service do you need?"
  }
};

// ====== i18n apply ======
function getPreferredLang() {
  const lang = (navigator.language || navigator.userLanguage || "en").toLowerCase();
  return lang.startsWith("es") ? "es" : "en";
}

function applyI18n(lang) {
  const t = dict[lang] || dict.en;

  // update <html lang="">
  document.documentElement.lang = lang;

  // apply text nodes
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (t[key] !== undefined) el.textContent = t[key];
  });
}

// ====== Drawer ======
function setupDrawer() {
  const drawer = document.getElementById("drawer");
  const menuBtn = document.getElementById("menuBtn");
  const closeBtn = document.getElementById("closeDrawer");
  const backdrop = document.getElementById("drawerBackdrop");

  const open = () => {
    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden", "false");
    menuBtn.setAttribute("aria-expanded", "true");
  };

  const close = () => {
    drawer.classList.remove("open");
    drawer.setAttribute("aria-hidden", "true");
    menuBtn.setAttribute("aria-expanded", "false");
  };

  menuBtn?.addEventListener("click", open);
  closeBtn?.addEventListener("click", close);
  backdrop?.addEventListener("click", close);

  drawer?.querySelectorAll("a[href^='#']").forEach(a => {
    a.addEventListener("click", (e) => {
      const href = a.getAttribute("href");
      if (!href || href === "#") return;
      const target = document.querySelector(href);
      if (!target) return;
      e.preventDefault();
      close();
      setTimeout(() => {
        // account for sticky header
        const y = target.getBoundingClientRect().top + window.pageYOffset - 74;
        window.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
        history.replaceState(null, "", href);
      }, 60);
    });
  });
  document.addEventListener("keydown, (e) => {
    if (e.key === "Escape") close();
  });
}

// ====== Booking form ======
function setupBookingForm(){
  const form = document.getElementById("bookingForm");
  if(!form) return;

  const nameEl = document.getElementById("bkName");
  const lastEl = document.getElementById("bkLast");
  const addrEl = document.getElementById("bkAddr");
  const locEl  = document.getElementById("bkLoc");
  const locBtn = document.getElementById("bkLocBtn");

  const state = { lat:null, lng:null };

  const setLocText = () => {
    if(state.lat && state.lng){
      const map = `https://maps.google.com/?q=${state.lat},${state.lng}`;
      locEl.value = map;
    }
  };

  locBtn?.addEventListener("click", async (e) => {
    e.preventDefault();
    if(!navigator.geolocation){
      locEl.value = "Ubicación no disponible en este dispositivo.";
      return;
    }
    locEl.value = "Obteniendo ubicación…";
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        state.lat = pos.coords.latitude.toFixed(6);
        state.lng = pos.coords.longitude.toFixed(6);
        setLocText();
      },
      () => {
        locEl.value = "No se pudo obtener la ubicación. Puedes escribir la dirección.";
      },
      { enableHighAccuracy:true, timeout:9000, maximumAge:0 }
    );
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const tLang = document.documentElement.lang === "es" ? "es" : "en";
    const t = dict[tLang] || dict.en;

    const name = (nameEl?.value || "").trim();
    const last = (lastEl?.value || "").trim();
    const addr = (addrEl?.value || "").trim();
    const loc  = (locEl?.value || "").trim();

    const lines = [];
    lines.push("MICHAEL TAXI — Solicitud de servicio");
    if(name || last) lines.push(`Nombre: ${name} ${last}`.trim());
    if(addr) lines.push(`Dirección: ${addr}`);
    if(loc) lines.push(`Ubicación actual: ${loc}`);
    lines.push("");
    lines.push("Servicio que necesito: ");
    const msg = encodeURIComponent(lines.join("\n"));

    window.open(`https://wa.me/${WA_NUMBER}?text=${msg}`, "_blank", "noopener");
  });
}



// ====== WhatsApp pop ======
function setupWhatsAppPop() {
  const fab = document.getElementById("waFab");
  const pop = document.getElementById("waPop");
  const msgBtn = document.getElementById("waMsg");
  const callBtn = document.getElementById("waCall");

  const tLang = () => (document.documentElement.lang === "es" ? "es" : "en");

  const buildMsg = () => {
    const t = dict[tLang()] || dict.en;
    return encodeURIComponent(t.wa_line1);
  };

  const syncLinks = () => {
    const msg = buildMsg();
    if(msgBtn) msgBtn.href = `https://wa.me/${WA_NUMBER}?text=${msg}`;
    if(callBtn) callBtn.href = `tel:+${WA_NUMBER}`;
  };

  const close = () => {
    pop.classList.remove("open");
    pop.setAttribute("aria-hidden", "true");
  };

  syncLinks();

  fab?.addEventListener("click", (e) => {
    e.stopPropagation();
    syncLinks();
    if (pop.classList.contains("open")) {
      close();
    } else {
      pop.classList.add("open");
      pop.setAttribute("aria-hidden", "false");
    }
  });

  document.addEventListener("click", () => close());
  pop?.addEventListener("click", (e) => e.stopPropagation());
}



// Init
document.addEventListener("DOMContentLoaded", () => {
  const lang = getPreferredLang();
  applyI18n(lang);
  setupDrawer();
  setupWhatsAppPop();
  setupBookingForm();
});
